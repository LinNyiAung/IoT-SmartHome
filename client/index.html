<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <title>IoT Control Panel</title>
  
</head>
<body>
  <h1>IoT Control Panel</h1>
  
  <!-- LED Control Section -->
  <section>
    <h2>LED Control</h2>
    <button onclick="controlLED('ON')">Turn ON</button>
    <button onclick="controlLED('OFF')">Turn OFF</button>
    <p id="ledStatus">LED Status: --</p>
  </section>

  <!-- LDR Automation Control -->
<section>
  <h2>LED Automation Control</h2>
  <button id="ldrledautomationToggle" onclick="ldrledtoggleAutomation()">Turn Off LDR LED Automation</button>
</section>

  <!-- DHT11 Sensor Data Section -->
  <section class="sensor-data">
    <h2>Temperature and Humidity</h2>
    <p id="temperature">Temperature: -- °C</p>
    <p id="humidity">Humidity: -- %</p>
    <button onclick="fetchDHTData()">Refresh Data</button>
  </section>

  <!-- Current Sensor Data Section -->
  <section class="sensor-data">
    <h2>Current</h2>
    <p id="voltage">Voltage: -- </p>
    <p id="current">Current: -- </p>
    
  </section>

  <!-- Motion Detection -->
  <section class="sensor-data">
    <h2>Motion Detection</h2>
    <p id="motionStatus">Motion: --</p>
  </section>

  <!-- Ultrasonic Sensor -->
  <section class="sensor-data">
    <h2>Ultrasonic Sensor</h2>
    <p id="distance">Distance: -- cm</p>
  </section>

  <!-- LDR Sensor -->
  <section class="sensor-data">
    <h2>LDR Sensor</h2>
    <p id="lightIntensity">Light Intensity: --</p>
  </section>

  <!-- Servo Motor Control -->
  <section>
    <h2>Servo Motor Control</h2>
    <label for="servoAngle">Set Angle (0-180): </label>
    <input type="number" id="servoAngle" placeholder="Set Servo Angle" min="0" max="180">
    <button onclick="controlServo()">Set Angle</button>
  </section>

  <script>
    const apiUrl = 'http://localhost:5000/api';

    // LED control function
    async function controlLED(status) {
      try {
        const response = await fetch(`${apiUrl}/led/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        const result = await response.json();
        alert(result.message);
      } catch (error) {
        console.error("Error controlling LED:", error);
      }
    }

    // Fetch DHT11 sensor data
    async function fetchDHTData() {
      try {
        const response = await fetch(`${apiUrl}/dht`);
        const data = await response.json();
        document.getElementById("temperature").textContent = `Temperature: ${data.temperature} °C`;
        document.getElementById("humidity").textContent = `Humidity: ${data.humidity} %`;
      } catch (error) {
        console.error("Error fetching DHT data:", error);
      }
    }

    // Servo motor control function
    async function controlServo() {
      const angle = document.getElementById('servoAngle').value;
      try {
        const response = await fetch(`${apiUrl}/servo/angle`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ angle })
        });
        const result = await response.json();
        alert(result.message);
      } catch (error) {
        console.error("Error controlling servo:", error);
      }
    }

    let isLdrLedAutomationActive = true; // Assume ldr led automation is active by default

// Fetch current ldr led automation status on load
async function fetchLdrLedAutomationStatus() {
  try {
    const response = await fetch(`${apiUrl}/ldrledautomation/status`);
    const data = await response.json();
    isLdrLedAutomationActive = data.isActive;
    ldrledupdateAutomationButton();
  } catch (error) {
    console.error("Error fetching automation status:", error);
  }
}

// Toggle automation on/off
async function ldrledtoggleAutomation() {
  isLdrLedAutomationActive = !isLdrLedAutomationActive;
  try {
    const response = await fetch(`${apiUrl}/ldrledautomation/status`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ isActive: isLdrLedAutomationActive })
    });
    const result = await response.json();
    alert(result.message);
    ldrledupdateAutomationButton();
  } catch (error) {
    console.error("Error updating automation status:", error);
  }
}

// Update the button label based on automation status
function ldrledupdateAutomationButton() {
  const button = document.getElementById("ldrledautomationToggle");
  button.textContent = isLdrLedAutomationActive ? "Turn Off LDR LED Automation" : "Turn On LDR LED Automation";
}

// Call this function when the page loads


    // WebSocket connection for real-time sensor data updates
    const socket = new WebSocket("ws://localhost:5000");

    socket.onopen = () => {
      console.log("Connected to WebSocket");
    };

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      document.getElementById("temperature").textContent = `Temperature: ${data.temperature} °C`;
      document.getElementById("humidity").textContent = `Humidity: ${data.humidity} %`;
      document.getElementById("motionStatus").textContent = `Motion: ${data.motionDetected ? 'Detected' : 'Not Detected'}`;
      document.getElementById("distance").textContent = `Distance: ${data.distance} cm`;
      document.getElementById("lightIntensity").textContent = `Light Intensity: ${data.lightIntensity ? 'Not Detected' : 'Detected'}`;
      document.getElementById("ledStatus").textContent = `LED Status: ${data.ledStatus}`;
      document.getElementById("voltage").textContent = `Voltage: ${data.voltage}`;
      document.getElementById("current").textContent = `Current: ${data.current}`;
    };

    socket.onerror = (error) => {
      console.error("WebSocket error:", error);
    };


    fetchLdrLedAutomationStatus();
    // Initial load of DHT data
    fetchDHTData();
  </script>
</body>
</html>
